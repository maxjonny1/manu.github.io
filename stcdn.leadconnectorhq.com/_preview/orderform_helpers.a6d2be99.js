import{A as m,x as $,X as ee}from"./entry.28a6fb2e.js";import{ae as B,ag as H,k as te,ak as z,a6 as N,af as V,w as Q,U as j,V as X,W as Y,u as q,al as E,T as p,ab as re,ac as ie}from"./constants.219033a1.js";import{A as ae,d as ne,C as Z}from"./HLConst.8f085cc8.js";import{F as se}from"./FunnelServices.51bf4f01.js";import{f as G}from"./funnel_event_helper.f4a21d53.js";const Se={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},he=(e,t,i)=>{let o=[];return{updatedProducts:e.map(a=>{if(a._id===i._id){if(t>a.max)return a.qty=a.qty,o.push(`A maximum of ${a.max} units of ${a.name} only can be purchased`),a;if(t>a.price.availableQuantity&&a.price.trackInventory&&!a.price.allowOutOfStockPurchases)return a.qty=a.qty,o.push(`Only ${a.price.availableQuantity} units of ${a.name} are in stock`),a;a.qty=t}return a}),errorMessages:o}},ve=e=>{var t,i,o;return((t=e==null?void 0:e.price)==null?void 0:t.availableQuantity)<=0&&((i=e==null?void 0:e.price)==null?void 0:i.trackInventory)&&!((o=e==null?void 0:e.price)!=null&&o.allowOutOfStockPurchases)},we=(e,t)=>t.find(i=>i._id===e.id),oe=async({contactId:e,domain:t,pageUrl:i,locationId:o,productPreviewList:l,isCouponApplied:a,couponCode:r,couponSessionId:n,store:c,subType:f,traceId:I="",reCaptchaToken:s,isEcommercePurchase:h,shippingRateId:u,toZip:w,toState:_,toCountry:P,shippingCarrierRateId:b})=>{var d,T,k,C;try{const y=m("msgsndr_id").value,A=m("am_id").value,M=m("am_fingerprint").value,U=c.funnelName||"funnel";t||(t=window.location.hostname,i=window.location.pathname);const{funnelPageId:F,funnelId:W,stepId:L}=c,O={altId:o,altType:"location",shippingRateId:u,shippingCarrierRateId:b,contactId:e,source:{type:c.pageType===E.FUNNEL?E.FUNNEL:E.WEBSITE,subType:f,id:W,name:U,meta:{stepId:L,pageId:F,domain:t,pageUrl:i,affiliateManager:{id:A,fingerprint:M}}},products:l.map(v=>({id:h?v.selectedPrice._id:v._id,qty:v.qty||v.quantity})),fingerprint:y,trackingId:z(),traceId:I,toZip:w,toState:_,toCountry:P};a&&(O.couponCode=r,O.couponSessionId=n),s&&(O.captchaToken=s);const S=await p.createOrder(O);if(!((d=S.order)==null?void 0:d._id))throw new Error("Something went wrong while creating order. Please try again later.");return S}catch(y){return console.error(y),{error:!0,message:(k=(T=y==null?void 0:y.response)==null?void 0:T._data)==null?void 0:k.message,status:(C=y==null?void 0:y.response)==null?void 0:C.status}}},le=async(e,t,i,o,l,a)=>{var x,v,D;const r=m("msgsndr_id").value,n=m("am_id").value,c=m("am_fingerprint").value,f=X(e.locationId),I=Y(e.locationId),s=j(),h=e.funnelName||"funnel";let{domain:u,page_url:w}=t.query;u||(u=window.location.hostname,w=window.location.pathname);const{funnelPageId:_,funnelId:P,stepId:b}=e,d={eventType:"optin",domainName:u,pageUrl:w,funnelId:P,pageId:_,stepId:b},{address:T,country:k,state:C,city:y,zipcode:A,fullName:M,phoneNumber:U,emailId:F,companyName:W}=i,L={addressLine1:T,country:k||o,state:C,city:y,zip:A};s.medium=re.OrderForm,s.mediumId=d.stepId;const O={lead:!0,eventData:s,source:h,pageId:_,funnelId:P,sessionId:f,funnelEventData:d,sessionFingerprint:I||null},S={locationId:e.locationId,name:M,phone:U,email:(F==null?void 0:F.toLowerCase())||"",companyName:W,address:L,attribution:O,timezone:ie(),amId:String(n),amFingerprint:c,orderFormType:"one_step_form_submission",captchaToken:l};a.enableStickyContact&&(S.attribution.fingerprint=r,S.attribution.funnelEventData.fingerprint=r),a.enableForceCreate&&(S.attribution.forceCreate=!0),a.enableEmailValidation&&(S.attribution.session_d=Number(a.enableEmailValidation)||0);try{const g=await se.createContact(S);if(!g)throw new Error("Something went wrong. Please try again later.");if(r!==g.fingerprint){e.fingerprint=r;const R=m("msgsndr_id",{path:"/",maxAge:31536e3});R.value=g.fingerprint}z();const K=V(g);Q("_ud",K),$(()=>{G("track","SubmitApplication")});let J=g.sessionFingerprint;return s&&(B({sessionId:g.sessionId||null,locationId:e.locationId}),J&&H(e.locationId,J)),g}catch(g){return console.error(g),{error:!0,message:(v=(x=g==null?void 0:g.response)==null?void 0:x._data)==null?void 0:v.message,status:(D=g==null?void 0:g.response)==null?void 0:D.status}}},_e=async(e,t,i,o,l,a,r,n,c,f,I,s,h,u,w,_,P)=>{var b;if((!r||!r.id)&&(r=await le(e,t,i,o,l,a),l=void 0),r!=null&&r.error){let d={};return(r==null?void 0:r.status)===429?(d={error:!0,processingPayment:!1,showRecaptcha:!0},d):(d={error:!0,processingPayment:!1,cardErrorMsg:r.message||"We're sorry, but something went wrong. Please try again"},d)}if((r.id&&!n||!((b=n==null?void 0:n.order)!=null&&b._id))&&(n=await oe({contactId:r==null?void 0:r.id,domain:e.domain,pageUrl:e.pageUrl,locationId:e.locationId,productPreviewList:f,isCouponApplied:c,couponCode:s,couponSessionId:I,store:e,subType:u,traceId:r==null?void 0:r.traceId,reCaptchaToken:l,isEcommercePurchase:h,shippingRateId:w,toZip:i.zipcode,toState:_,toCountry:i.country,shippingCarrierRateId:P}),l=void 0),n!=null&&n.error){let d={};return n.status===429?(d={error:!0,processingPayment:!1,showRecaptcha:!0,contactResponse:r},d):(d={error:!0,processingPayment:!1,contactResponse:r,cardErrorMsg:n.message||"We're sorry, but something went wrong. Please try again"},d)}return(n==null?void 0:n.success)===!1?{error:!0,cardErrorMsg:n==null?void 0:n.message,processingPayment:!1}:(sessionStorage.setItem("orderResponse",JSON.stringify(n)),u!=N.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(r)),sessionStorage.setItem("orderResponse",JSON.stringify(n)),u!=N.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(r)),sessionStorage.setItem("orderResponse",JSON.stringify(n)),u!=N.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(r)),{contactResponse:r,orderResponse:n,reCaptchaToken:l})},ue=(e,t,i,o)=>{var a;if(z()!=i.verifiedTrackingId){const r=m("tr",{path:"/",maxAge:900});r.value=i.verifiedTrackingId}if(o!==N.TWO_STEP_ORDER_FORM){if(e.fingerprint!==t){const n=m("msgsndr_id",{path:"/",maxAge:31536e3});n.value=e.fingerprint}const r=V(e);Q("_ud",r)}if((a=e==null?void 0:e.attribution_source)!=null&&a.fbEventId){let r=e.attribution_source.fbEventId;$(()=>{G("track","OrderFormPurchase",r)})}else console.warn("Facebook event Id missing from attribution!")},Pe=async(e,t,i,o,l)=>{let a=!1,r="";if(t.message&&!t.success)throw new Error(t.message);i===ae&&(t!=null&&t.pendingConfirmation)&&(a=!0,r="Order placed successfully! However your transaction is pending for review. Please contact the business owner");const n=m("msgsndr_id").value;await ue(e,n,t,l);const c=m("provider");c.value=i===ne?"pp":i===Z?Z:"cc",await de({sessionId:e.sessionId,sessionFingerprint:t.sessionFingerprint},o);const f=sessionStorage.getItem("redirect");if(ge(o),f){sessionStorage.removeItem("redirect"),window.location.href=f;return}return{paymentResponseData:t,authorizeOrderPendingConfirmation:a,authorizeOrderAlertMsg:r}},de=(e,t)=>{e&&e.sessionId&&(B({sessionId:e.sessionId||null,locationId:t}),e.sessionFingerprint&&H(t,e.sessionFingerprint))},be=(e,t,i)=>{var o;return{facilitatorAccessToken:e.facilitatorAccessToken,orderId:(o=t==null?void 0:t.order)==null?void 0:o._id,paypalOrderId:e.orderID,altId:i,altType:"location",attribution:{eventData:j(),sessionId:X(i),sessionFingerprint:Y(i)}}},Oe=e=>{var i;(!(e.keyCode>=48&&e.keyCode<=57||e.keyCode>=96&&e.keyCode<=105)||!/^\d{0,2}$/.test((i=e.target)==null?void 0:i.value))&&e.keyCode!==8&&e.preventDefault()},ge=e=>{const t=te();return sessionStorage.setItem(`couponSessionId_${e}`,t),t},Ee=async(e,t,i="",o,l,a)=>{var r,n,c,f,I;try{const s=q(),h={altId:s.value.locationId,altType:"location",couponCode:i,source:{type:s.value.pageType===E.FUNNEL?E.FUNNEL:E.WEBSITE,subType:t,id:s.value.funnelId,name:s.value.funnelName,meta:{stepId:s.value.stepId,pageId:s.value.funnelPageId,domain:s.value.domain,pageUrl:s.value.pageUrl,affiliateManager:{id:m("am_id").value,fingerprint:m("msgsndr_id").value}}},products:e,toCountry:o,toState:l,toZip:a},u=await p.getAmountSummary(h);return{total:u.summary.total,subtotal:u.summary.subtotal,taxSummary:u.summary.taxSummary,subtotalWithDiscount:u.summary.subtotalWithDiscount,futureRecurringPaymentAmount:(r=u.recurringSummary)==null?void 0:r.subtotalWithDiscount}}catch(s){return console.error(s),{error:!0,message:((c=(n=s==null?void 0:s.response)==null?void 0:n._data)==null?void 0:c.message)||"Something went wrong while fetching order total. Please try again later",status:(I=(f=s==null?void 0:s.response)==null?void 0:f._data)==null?void 0:I.status}}},Fe=async(e,t)=>{const i=await p.getLastPaymentMethodForTheCustomer({altId:e,altType:"location",contactId:t});return i==null?void 0:i.paymentMethod},Te=(e,t,i,o)=>{const l=t<=0&&!i,a=i&&o<=0;return e&&(l||a)},ke=async()=>{const e=q();try{const t=await p.getStatesInformation();if(t&&t.error)throw ee(t.error);e.value.countryList=(t==null?void 0:t.data)??[]}catch(t){console.error("Failed to fetch country list",t)}},Ce=e=>q().value.countryList.find(i=>i.code===e);export{Ce as a,Ee as b,oe as c,ge as d,we as e,Fe as f,ke as g,Pe as h,ve as i,be as j,he as k,_e as l,Oe as m,Te as p,Se as s};
